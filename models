const bcrypt = require('bcrypt');
const db = require('./dbModule.js');


module.exports = {

    getMother: function (request, response) {
        const username = request.body.username;
        const password = request.body.password;

        db.getMother(username, function (error, result) {

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result === null || result.rows.length !== 1) {
                response.status(500).json({success: false, data: error, result: result});
            } else {
                const mother = result.rows[0];
                bcrypt.compare(password, mother.password, function (err, res) {
                    if (res) {
                        // Passwords match
                        response.status(200).json(mother); //ok
                    } else {
                        // Passwords don't match
                        response.status(400).json({success: false, data: "Wrong Username or password"});
                    }
                });
            }
        });
    },
    getKickSession: function (request, response) {
        const kickSessionId = request.param.kickSessionId;

        // TODO: We should really check here for a valid id before continuing on...
        db.getKickSession(kickSessionId, function (error, result) {

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result == null || result.rows.length !== 1) {
                response.status(500).json({success: false, data: error});
            } else {
                const kickSession = result.rows[0];
                db.getKicks(kickSessionId, addKicksToKickSession.bind({response: response, kickSession: kickSession}));
            }
        });
    },
    getKick: function (request, response) {
        const kickId = request.query.kickId;

        // TODO: We should really check here for a valid id before continuing on...
        db.getKick(kickId, function (error, result) {

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result == null || result.rows.length !== 1) {
                response.status(500).json({success: false, data: error});
            } else {
                const kick = result.rows[0];
                response.status(200).json(kick);
            }
        });
    },
    getKickSessions: function (request, response) {
        const motherId = request.query.motherId;

        // TODO: We should really check here for a valid id before continuing on...
        db.getKickSessions(motherId, function (error, result) {
            // This is the callback function that will be called when the DB is done.
            // The job here is just to send it back.

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result == null) {
                response.status(500).json({success: false, data: error});
            } else {
                const kickSessions = result.rows;
                kickSessions.forEach(kickSession => {
                    db.getKicks(kickSession.id, addKicksToKickSession.bind({kickSession: kickSession})); //check this, it might not need to wait to respond
                });
                response.status(200).json(kickSessions);
            }
        });
    },
    getKicks: function (request, response) {
        const kickSessionId = request.query.kickSessionId;

        // TODO: We should really check here for a valid id before continuing on...
        db.getKicks(kickSessionId, function (error, result) {

            if (error || result == null) {
                response.status(500).json({success: false, data: error});
            } else {
                const kicks = result.rows;
                response.status(200).json(kicks);
            }
        });
    },
    updateKickSession: function (request, response) {

    },

    createMother: function (request, response) {
        const username = request.body.username;

        bcrypt.hash(request.body.password, 10, (err, password) => {
            // Store hash in database
            db.createMother(username, password, function (error, result) {

                // Make sure we got a row with the person, then prepare JSON to send back
                if (error || result == null) {
                    response.status(500).json({success: false, data: error});
                } else {
                    const mother = result.rows[0];
                    response.status(200).json(mother);
                }
            });
        });

    },
    createKickSession: function (request, response) {
        const startTime = request.body.startTime;
        const motherId = request.body.motherId; //or from cookies?

        // Store hash in database
        db.createKickSession(startTime, motherId, function (error, result) {

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result == null) {
                response.status(500).json({success: false, data: error});
            } else {
                const kickSession = result.rows[0];
                db.createKick(startTime, kickSession.id, addKicksToKickSession.bind({response: response, kickSession: kickSession}));
            }
        });
    },
    createKick: function (request, response) {
        const time = request.body.time;
        const kickSessionId = request.body.kickSessionId; //or from cookies?

        // Store hash in database
        db.createKick(time, kickSessionId, function (error, result) {

            // Make sure we got a row with the person, then prepare JSON to send back
            if (error || result == null) {
                response.status(500).json({success: false, data: error});
            } else {
                const kick = result.rows[0];
                response.status(200).json(kick);
            }
        });
    }

};

function addKicksToKickSession(error, result) {
    if (result !== null) {
        this.kickSession.kicks = result.rows;
    }
    if (this.response) {
        if (error || result == null) {
            this.response.status(500).json({success: false, data: error});
        } else {
            this.response.status(200).json(this.kickSession);
        }
    }

}
